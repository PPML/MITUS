---
title: "MITUS paper update" 
author: "Nicole A. B. Swartwood"
date: "`r Sys.Date()`"
output: rmarkdown::pdf_document
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

Table 1: Risk Populations and Selected Characteristics 

```{r, warning=FALSE, message=FALSE,echo=FALSE, fig.width=7.5, fig.height=6.5}
library(MITUS)
library(knitr)
library(ggplot2)
library(gridExtra)
library(reshape2)

## need to get the population sizes from the model in 2020 
#load the data for national
model_load("US")
#setup the risk population parameters
ttt_input<-risk_pop_setup()
Opt <- readRDS("~/MITUS/inst/US/US_Optim_all_10_1031.rds")
Par<-gen_par_matrix(Opt[,-59])
prg_chng<-def_prgchng(Par[3,])
results<-national_OutputsZint(samp_i = 3,
                     ParMatrix = Par, 
                     prg_chng = prg_chng, 
                     ttt_input=list(def_ttt_nat_ag()))
pop_size<-results[71,33:54]
pop_size<-cbind(pop_size[1:11],pop_size[12:22])

#import our age specific population prevalence rates 
prevalence_percent<-read.csv(file="~/Desktop/RiskPopPrevalence.csv")[,-1]/100
rownames(prevalence_percent)<-read.csv(file="~/Desktop/RiskPopPrevalence.csv")[,1]

#calculate population sizes 
risk_populations<-list()
# risk_populations
# ##add in the children under 5 
# # risk_populations[[1]]<-
# ##add in the immigrants
# risk_populations[[2]]<-cbind(matrix(0,11,1), pop_size[,2])
for (i in 1:nrow(prevalence_percent)){
  risk_populations[[i]]<-t(rbind(pop_size[,1]*prevalence_percent[i,],pop_size[,2]*prevalence_percent[i,]))
  colnames(risk_populations[[i]])<-colnames(pop_size)[i]
}

#create entries for children under 5 and immigrants
x<-list(rbind(pop_size[1,], matrix(0,10,2)), 
  cbind(matrix(0,11,1), pop_size[,2]))
risk_populations<- append(x,risk_populations)
#add in the names 
names(risk_populations)<-c("Child5yr",
                           "Immigrants",
                           rownames(prevalence_percent))
#calculate the total population 
total_population<-sum(pop_size)
#calculate the percent of the population each risk group is 
frc_pop<-rep(0,length(risk_populations))
names(frc_pop)<-names(risk_populations)
for (i in 1:length(risk_populations)){
frc_pop[i]<-sum(risk_populations[[i]])/total_population
}
# frc_pop<-round(frc_pop,2)
#create our data frame of populations 
#make the population matrix 
HIVD<-HIVU<-c(24.9,2.19,1)
DiabetesD<-DiabetesU<-c(3,1.89,2.12)
SilicosisD<-SilicosisU<-c(30,5,1)
ESRDD<-ESRDU<-c(15,12.8,1) #values to be updated
Child5yr<-c(2,1.2,1.3)
PWID<-c(3,2,1.5)
ImmunosupTherapy<-c(10,3,1)
#abCXR<-c(.15,2,1,2)
#Contact<-c(.2,1,1,8)
Immigrants<-c(1,1,10)
#Healthcare<-c(18,1,1,5)
CongregateSettings<-c(1,1,8) 
targetedPopDesc<-rbind(Child5yr,
                       Immigrants,
                       HIVD,
                       HIVU, 
                       DiabetesD,
                       DiabetesU,
                       ESRDD,
                       ESRDU,
                       SilicosisD,
                       SilicosisU,
                       PWID,
                       ImmunosupTherapy,
                       CongregateSettings)
targetedPopDesc<-cbind(round(frc_pop,4)*100, targetedPopDesc[,1:ncol(targetedPopDesc)])
colnames(targetedPopDesc)<-c("Perc. of Pop",
                             "RR TB Prog.",
                             "RR of Mu",
                             "RR of LTBI")
rownames(targetedPopDesc)<-c("Child < 5 yrs",
                             "Immigrants",
                             "Diagnosed HIV",
                             "Undiagnosed HIV",
                             "Diagnosed Diabetes",
                             "Undiagnosed Diabetes",
                             "Diagnosed Silicosis",
                             "Undiagnosed Silicosis",
                             "Diagnosed ESRD",
                             "Undiagnosed ESRD",
                             "PWID",
                             "Immunosuppressive Therapy",
                              "Congregate Settings")
targetedPopDesc<-as.data.frame(targetedPopDesc)
kable(targetedPopDesc, 
      caption = "Descriptive Characteristics of Modelled Risk Populations")
```

Run Univariate analyses in R 

```{r, warning=FALSE, message=FALSE,echo=FALSE, fig.width=7.5, fig.height=6.5}
library(MITUS)
#load the data for national
model_load("US")
#setup the risk population parameters
ttt_input<-risk_pop_setup()
Opt <- readRDS("~/MITUS/inst/US/US_Optim_all_10_1031.rds")
Par<-gen_par_matrix(Opt[,-59])
prg_chng<-def_prgchng(Par[3,])
results<-national_OutputsZint(samp_i = 3,
                     ParMatrix = Par, 
                     prg_chng = prg_chng, 
                     ttt_input=list(def_ttt_nat_ag()))
#
```


