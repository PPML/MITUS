---
title: "Mortality Update"
geometry: margin=2cm
output: rmarkdown::pdf_document
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

Mortality in the MITUS model has been a continual issue. It was the hopes that inputting new mortality rate inputs into the model would help solve this problem, but unfortunately, after expanded optimization attempts, the model continues to kill "too many" persons in the oldest age groups (age 85+.)     

Current model parameterizations:     
  * Starting population - 1950 census for "United States" + Alaska and Hawaii  
    + Previous estimate was ~ 2 million higher; source -- cites US residents, Alaska, Hawaii, and military abroad.   
    + If we'd like to revert to this estimate, we would need to update our population targets to be in parallel with this specification; previously, we started with a population of 152 million in 1950, but our calibration target for the same year was 1950. 
* Mortality rates - NCHS has age specific mortality rates. I have used these for the model inputs. See graphs of comparison to old mortality rates below.     
```{r, echo=FALSE,message=FALSE, warning=FALSE, fig.width=4}
library(MITUS)
model_load("US")
NCHS_mort<-readRDS(system.file("US/US_NCHS_mort.rds", package="MITUS"))
col<-rainbow(11)

for (i in 2:12){
  plot(0,0,ylim=c(min(NCHS_mort[,i],Inputs$BgMort[1:68,i])*.5,max(NCHS_mort[,i],Inputs$BgMort[1:68,i])*1.5),xlim=c(1950,2017),xlab="",ylab="",axes=F)
  axis(1, cex.axis=.75);axis(2,las=2, cex.axis=.75);box()
  abline(h=axTicks(2),col="grey85")
  lines(1950:2017, NCHS_mort[,i], lwd=3, col=col[i-1])
  lines(1950:2017, Inputs$BgMort[1:68,i], lty=3, lwd=2, col=col[i-1])
  mtext("Year",1,2.5,cex=.75)
  mtext(paste("Age Specific Mortality Rates from 1950 to 2017", colnames(Inputs$BgMort)[i]),3,.8,font=2,cex=.75)
  legend("topright",c("NCHS","lifetables"),cex=.75,
  pch=c(NA,NA),lwd=c(3,3),lty=c(1,3),col=col[i-1],bg="white",pt.cex=c(1.8,1.8))
}
```


# Final checks of the mortality dynamics. 

1. Check the aging process in the model. 
  + Aging takes 60 months for 0-4 and 120 months for the others.
  + See code chunk below. 
```
        /////////////////////////////////////AGING///////////////////////////////////////
      for(int ag=0; ag<10; ag++) {
        /////          IF AGE > 4, IT TAKES 120 MONTHS TO LEAVE AGE GROUP          /////
        if(ag>0) {
          temp2 = 120;
          /////          IF AGE < 4, IT TAKES 60 MONTHS TO LEAVE AGE GROUP           /////
        } else {
          temp2 = 60;
        }
        for(int tb=0; tb<6; tb++) {
          for(int lt=0; lt<2; lt++){
            for (int im=0; im<4; im++){
              for (int nm=0; nm<4; nm++){
                for(int rg=0; rg<2; rg++) {
                  for(int na=0; na<3; na++){
                    temp = V0[ag  ][tb][lt][im][nm][rg][na]/temp2;
                    V1[ag  ][tb][lt][im][nm][rg][na]  -= temp;
                    V1[ag+1][tb][lt][im][nm][rg][na]  += temp;
                  } } } } } } }
```
2. Convert mortality rates to probabilities using the following formula. 
```
mubt[,]<-1-exp(-mubt[,])
```
  + This does not significantly change the results. 
  
3. Check the coding of mortality ceiling to ensure it is not allowing the model to bypass the goal of the limit.   
  + Previously, we limited the combined RR modification to 5 times the background mortality.
  + However, optimization allows for the adjustment of the background mortality, allowing our total limit to be bypassed. 
  + New coding: removal of mortality ceiling. 
  
4. Attempt to revert the model back to previous coding but without mortality ceiling -- does this help?
  + No. 
  
5. Check the population and mortality inputs. 
```{r, message=FALSE, warning=FALSE, fig.width=4}
library(MITUS)
model_load("US")
CalibDat[["tot_pop_yr_fb"]]
```
  + These are consistent with the denominators used in the NCHS mortality rate calculations. 
  + Resident population. 
  
# Current Model pre-Optimization and with no rebalancing 
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=4}
library(MITUS)
model_load("US")
 prms <-list()
  prms <- param_noRB(P)
  IP <- list()
  IP <- param_init(P)
  tm<-matrix(0,4,4)
  diag(tm)<-1
  trans_mat_tot_ages<<-matrix(tm,4,44)
  zz <- cSim(  nYrs       = 2018-1950         , nRes      = length(prms[["ResNam"]])  , rDxt     = prms[["rDxt"]]  , TxQualt    = prms[["TxQualt"]]   , InitPop  = prms[["InitPop"]],
               Mpfast     = prms[["Mpfast"]]    , ExogInf   = prms[["ExogInf"]]       , MpfastPI = prms[["MpfastPI"]], Mrslow     = prms[["Mrslow"]]    , rrSlowFB = prms[["rrSlowFB"]]  ,
               rfast      = prms[["rfast"]]     , RRcurDef  = prms[["RRcurDef"]]      , rSlfCur  = prms[["rSlfCur"]] , p_HR       = prms[["p_HR"]]      , dist_gen = prms[["dist_gen"]]    ,
               vTMort     = prms[["vTMort"]]    , RRmuRF    = prms[["RRmuRF"]]        , RRmuHR   = prms[["RRmuHR"]]  , Birthst  = prms[["Birthst"]]    ,
               HrEntEx    = prms[["HrEntEx"]]   , ImmNon    = prms[["ImmNon"]]        , ImmLat   = prms[["ImmLat" ]] , ImmAct     = prms[["ImmAct"]]    , ImmFst   = prms[["ImmFst" ]]    ,
               net_mig_usb = prms[["net_mig_usb"]], net_mig_nusb = prms[["net_mig_nusb"]],
               mubt       = prms[["mubt"]]    , RelInf    = prms[["RelInf"]]        , RelInfRg = prms[["RelInfRg"]], Vmix       = prms[["Vmix"]]      , rEmmigFB = prms [["rEmmigFB"]]  ,
               TxVec      = prms[["TxVec"]]     , TunTxMort = prms[["TunTxMort"]]     , rDeft    = prms[["rDeft"]]   , pReTx      = prms[["pReTx"]]     , LtTxPar  = prms[["LtTxPar"]]    ,
               LtDxPar    = prms[["LtDxPar"]]   , rLtScrt   = prms[["rLtScrt"]]       , RRdxAge  = prms[["RRdxAge"]] , rRecov     = prms[["rRecov"]]    , pImmScen = prms[["pImmScen"]]   ,
               EarlyTrend = prms[["EarlyTrend"]], NixTrans = IP[["NixTrans"]],   trans_mat_tot_ages = trans_mat_tot_ages)
  M <- zz$Outputs
  colnames(M) <- prms[["ResNam"]]
  df<-as.data.frame(M)
  tb_graph_demo(df,FALSE)
```

# Post Optimization

```{r,echo=FALSE,  message=FALSE, warning=FALSE, fig.width=4}
library(MITUS)
model_load("US")
load("~/MITUS/Opt_US_r3_noRB_1_2019-04-02_n.rda")
Par<-o3$par
  Par2 <- pnorm(Par,0,1)
  # uniform to true
  Par3 <- Par2
  Par3[idZ0] <- qbeta( Par2[idZ0], shape1  = ParamInitZ[idZ0,6], shape2 = ParamInitZ[idZ0,7])
  Par3[idZ1] <- qgamma(Par2[idZ1], shape   = ParamInitZ[idZ1,6], rate   = ParamInitZ[idZ1,7])
  Par3[idZ2] <- qnorm( Par2[idZ2], mean    = ParamInitZ[idZ2,6], sd     = ParamInitZ[idZ2,7])
  P[ii] <- Par3
  P <- P
 prms <-list()
  prms <- param_noRB(P)
  IP <- list()
  IP <- param_init(P)
  tm<-matrix(0,4,4)
  diag(tm)<-1
  trans_mat_tot_ages<<-matrix(tm,4,44)
  zz <- cSim(  nYrs       = 2018-1950         , nRes      = length(prms[["ResNam"]])  , rDxt     = prms[["rDxt"]]  , TxQualt    = prms[["TxQualt"]]   , InitPop  = prms[["InitPop"]],
               Mpfast     = prms[["Mpfast"]]    , ExogInf   = prms[["ExogInf"]]       , MpfastPI = prms[["MpfastPI"]], Mrslow     = prms[["Mrslow"]]    , rrSlowFB = prms[["rrSlowFB"]]  ,
               rfast      = prms[["rfast"]]     , RRcurDef  = prms[["RRcurDef"]]      , rSlfCur  = prms[["rSlfCur"]] , p_HR       = prms[["p_HR"]]      , dist_gen = prms[["dist_gen"]]    ,
               vTMort     = prms[["vTMort"]]    , RRmuRF    = prms[["RRmuRF"]]        , RRmuHR   = prms[["RRmuHR"]]  , Birthst  = prms[["Birthst"]]    ,
               HrEntEx    = prms[["HrEntEx"]]   , ImmNon    = prms[["ImmNon"]]        , ImmLat   = prms[["ImmLat" ]] , ImmAct     = prms[["ImmAct"]]    , ImmFst   = prms[["ImmFst" ]]    ,
               net_mig_usb = prms[["net_mig_usb"]], net_mig_nusb = prms[["net_mig_nusb"]],
               mubt       = prms[["mubt"]]    , RelInf    = prms[["RelInf"]]        , RelInfRg = prms[["RelInfRg"]], Vmix       = prms[["Vmix"]]      , rEmmigFB = prms [["rEmmigFB"]]  ,
               TxVec      = prms[["TxVec"]]     , TunTxMort = prms[["TunTxMort"]]     , rDeft    = prms[["rDeft"]]   , pReTx      = prms[["pReTx"]]     , LtTxPar  = prms[["LtTxPar"]]    ,
               LtDxPar    = prms[["LtDxPar"]]   , rLtScrt   = prms[["rLtScrt"]]       , RRdxAge  = prms[["RRdxAge"]] , rRecov     = prms[["rRecov"]]    , pImmScen = prms[["pImmScen"]]   ,
               EarlyTrend = prms[["EarlyTrend"]], NixTrans = IP[["NixTrans"]],   trans_mat_tot_ages = trans_mat_tot_ages)
  M <- zz$Outputs
  colnames(M) <- prms[["ResNam"]]
  df<-as.data.frame(M)
  tb_graph_demo(df,FALSE)
```

# with rebalancing 
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=4}
library(MITUS)
model_load("US")
load("~/MITUS/Opt_US_r2_1_2019-04-02_n.rda")
Par<-o2$par
  Par2 <- pnorm(Par,0,1)
  # uniform to true
  Par3 <- Par2
  Par3[idZ0] <- qbeta( Par2[idZ0], shape1  = ParamInitZ[idZ0,6], shape2 = ParamInitZ[idZ0,7])
  Par3[idZ1] <- qgamma(Par2[idZ1], shape   = ParamInitZ[idZ1,6], rate   = ParamInitZ[idZ1,7])
  Par3[idZ2] <- qnorm( Par2[idZ2], mean    = ParamInitZ[idZ2,6], sd     = ParamInitZ[idZ2,7])
  P[ii] <- Par3
  P <- P
  prms <-list()
  prms <- param(P)
  IP <- list()
  IP <- param_init(P)

  trans_mat_tot_ages<<-reblncd(mubt = prms$mubt,can_go = can_go,RRmuHR = prms$RRmuHR[2], RRmuRF = prms$RRmuRF, HRdist = HRdist, dist_gen_v=dist_gen_v, adj_fact=prms[["adj_fact"]])
  if(any(trans_mat_tot_ages>1)) print("transition probabilities are too high")
  zz <- cSim( nYrs       = 2018-1950         , nRes      = length(prms[["ResNam"]])  , rDxt     = prms[["rDxt"]]  , TxQualt    = prms[["TxQualt"]]   , InitPop  = prms[["InitPop"]]    ,
               Mpfast     = prms[["Mpfast"]]    , ExogInf   = prms[["ExogInf"]]       , MpfastPI = prms[["MpfastPI"]], Mrslow     = prms[["Mrslow"]]    , rrSlowFB = prms[["rrSlowFB"]]  ,
               rfast      = prms[["rfast"]]     , RRcurDef  = prms[["RRcurDef"]]      , rSlfCur  = prms[["rSlfCur"]] , p_HR       = prms[["p_HR"]]      , dist_gen = prms[["dist_gen"]]    ,
               vTMort     = prms[["vTMort"]]    , RRmuRF    = prms[["RRmuRF"]]        , RRmuHR   = prms[["RRmuHR"]]  , Birthst  = prms[["Birthst"]]    ,
               HrEntEx    = prms[["HrEntEx"]]   , ImmNon    = prms[["ImmNon"]]        , ImmLat   = prms[["ImmLat"]] , ImmAct     = prms[["ImmAct"]]    , ImmFst   = prms[["ImmFst"]]    ,
               net_mig_usb = prms[["net_mig_usb"]], net_mig_nusb = prms[["net_mig_nusb"]],
               mubt       = prms[["mubt"]]    , RelInf    = prms[["RelInf"]]        , RelInfRg = prms[["RelInfRg"]], Vmix       = prms[["Vmix"]]      , rEmmigFB = prms [["rEmmigFB"]]  ,
               TxVec      = prms[["TxVec"]]     , TunTxMort = prms[["TunTxMort"]]     , rDeft    = prms[["rDeft"]]   , pReTx      = prms[["pReTx"]]     , LtTxPar  = prms[["LtTxPar"]]    ,
               LtDxPar    = prms[["LtDxPar"]]   , rLtScrt   = prms[["rLtScrt"]]       , RRdxAge  = prms[["RRdxAge"]] , rRecov     = prms[["rRecov"]]    , pImmScen = prms[["pImmScen"]]   ,
               EarlyTrend = prms[["EarlyTrend"]], NixTrans = IP[["NixTrans"]],   trans_mat_tot_ages = trans_mat_tot_ages)
    M <- zz$Outputs
  colnames(M) <- prms[["ResNam"]]
  df<-as.data.frame(M)
  tb_graph_demo(df,FALSE)
  ### CHECK REBALANCING 
  ## GOAL DIST 
  rowSums(dist_gen)
  ## MODEL DIST 
      v21a<- v21  <- M[51:67,521:564]
    for (i in 1:11){
      denom<-M[51:67,2+i]
      for (j in 1:ncol(v21)){
        v21a[,(1:4)+4*(i-1)]<-v21[,(1:4)+4*(i-1)]/denom
      } }
   v21a
```
# with rebalancing but adjustment factor turned to zero
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=4}
library(MITUS)
model_load("US")
load("~/MITUS/Opt_US_r2_1_2019-04-02_n.rda")
Par<-o2$par
  Par2 <- pnorm(Par,0,1)
  # uniform to true
  Par3 <- Par2
  Par3[idZ0] <- qbeta( Par2[idZ0], shape1  = ParamInitZ[idZ0,6], shape2 = ParamInitZ[idZ0,7])
  Par3[idZ1] <- qgamma(Par2[idZ1], shape   = ParamInitZ[idZ1,6], rate   = ParamInitZ[idZ1,7])
  Par3[idZ2] <- qnorm( Par2[idZ2], mean    = ParamInitZ[idZ2,6], sd     = ParamInitZ[idZ2,7])
  P[ii] <- Par3
  P <- P
  P[["adj_ag1"]]<-P[["adj_ag1"]]<-0
  prms <-list()
  prms <- param(P)
  IP <- list()
  IP <- param_init(P)

  trans_mat_tot_ages<<-reblncd(mubt = prms$mubt,can_go = can_go,RRmuHR = prms$RRmuHR[2], RRmuRF = prms$RRmuRF, HRdist = HRdist, dist_gen_v=dist_gen_v, adj_fact=prms[["adj_fact"]])
  if(any(trans_mat_tot_ages>1)) print("transition probabilities are too high")
  zz <- cSim( nYrs       = 2018-1950         , nRes      = length(prms[["ResNam"]])  , rDxt     = prms[["rDxt"]]  , TxQualt    = prms[["TxQualt"]]   , InitPop  = prms[["InitPop"]]    ,
               Mpfast     = prms[["Mpfast"]]    , ExogInf   = prms[["ExogInf"]]       , MpfastPI = prms[["MpfastPI"]], Mrslow     = prms[["Mrslow"]]    , rrSlowFB = prms[["rrSlowFB"]]  ,
               rfast      = prms[["rfast"]]     , RRcurDef  = prms[["RRcurDef"]]      , rSlfCur  = prms[["rSlfCur"]] , p_HR       = prms[["p_HR"]]      , dist_gen = prms[["dist_gen"]]    ,
               vTMort     = prms[["vTMort"]]    , RRmuRF    = prms[["RRmuRF"]]        , RRmuHR   = prms[["RRmuHR"]]  , Birthst  = prms[["Birthst"]]    ,
               HrEntEx    = prms[["HrEntEx"]]   , ImmNon    = prms[["ImmNon"]]        , ImmLat   = prms[["ImmLat"]] , ImmAct     = prms[["ImmAct"]]    , ImmFst   = prms[["ImmFst"]]    ,
               net_mig_usb = prms[["net_mig_usb"]], net_mig_nusb = prms[["net_mig_nusb"]],
               mubt       = prms[["mubt"]]    , RelInf    = prms[["RelInf"]]        , RelInfRg = prms[["RelInfRg"]], Vmix       = prms[["Vmix"]]      , rEmmigFB = prms [["rEmmigFB"]]  ,
               TxVec      = prms[["TxVec"]]     , TunTxMort = prms[["TunTxMort"]]     , rDeft    = prms[["rDeft"]]   , pReTx      = prms[["pReTx"]]     , LtTxPar  = prms[["LtTxPar"]]    ,
               LtDxPar    = prms[["LtDxPar"]]   , rLtScrt   = prms[["rLtScrt"]]       , RRdxAge  = prms[["RRdxAge"]] , rRecov     = prms[["rRecov"]]    , pImmScen = prms[["pImmScen"]]   ,
               EarlyTrend = prms[["EarlyTrend"]], NixTrans = IP[["NixTrans"]],   trans_mat_tot_ages = trans_mat_tot_ages)
    M <- zz$Outputs
  colnames(M) <- prms[["ResNam"]]
  df<-as.data.frame(M)
  tb_graph_demo(df,FALSE)
  ### CHECK REBALANCING 
  ## GOAL DIST 
  rowSums(dist_gen)
  ## MODEL DIST 
      v21a<- v21  <- M[51:67,521:564]
    for (i in 1:11){
      denom<-M[51:67,2+i]
      for (j in 1:ncol(v21)){
        v21a[,(1:4)+4*(i-1)]<-v21[,(1:4)+4*(i-1)]/denom
      } }
   v21a
```

Comparing these with the plots above, there is very little (if any) difference -- adjustment factor/reblancing is not working appropriately. Will need to fix this after mortality. 


